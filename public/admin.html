<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>퀴즈 관리</title>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family: 'Noto Sans KR', -apple-system, sans-serif;
  background:#0f0f1a; color:#e0e0e0; min-height:100vh; padding:20px;
}
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');

h1 { font-size:1.6rem; margin-bottom:20px; color:#fff; }
h2 { font-size:1.2rem; margin:20px 0 10px; color:#aaa; }

.container { max-width:800px; margin:0 auto; }

/* 퀴즈 목록 */
.quiz-list { display:flex; flex-direction:column; gap:10px; margin-bottom:30px; }
.quiz-card {
  background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1);
  border-radius:12px; padding:16px 20px; cursor:pointer;
  display:flex; justify-content:space-between; align-items:center;
  transition:background 0.2s;
}
.quiz-card:hover { background:rgba(102,126,234,0.1); }
.quiz-card.active { border-color:#667eea; background:rgba(102,126,234,0.15); }
.quiz-card-title { font-weight:700; }
.quiz-card-info { font-size:0.85rem; color:#888; }

/* 버튼 */
.btn {
  border:none; color:#fff; font-size:0.9rem; font-weight:700;
  padding:10px 20px; border-radius:8px; cursor:pointer; transition:opacity 0.2s;
}
.btn:hover { opacity:0.85; }
.btn-primary { background:linear-gradient(135deg,#667eea,#764ba2); }
.btn-danger { background:#e74c3c; }
.btn-sm { padding:6px 14px; font-size:0.8rem; }
.btn-group { display:flex; gap:8px; flex-wrap:wrap; margin:10px 0; }

/* 입력 */
input, textarea, select {
  background:rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.15);
  color:#fff; padding:10px 14px; border-radius:8px; font-size:0.95rem;
  width:100%; margin-bottom:10px; font-family:inherit;
}
input:focus, textarea:focus, select:focus { outline:none; border-color:#667eea; }
textarea { resize:vertical; min-height:60px; }
label { font-size:0.85rem; color:#aaa; margin-bottom:4px; display:block; }

/* 문제 카드 */
.question-card {
  background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08);
  border-radius:12px; padding:16px; margin-bottom:14px;
}
.question-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
.question-num { font-weight:700; color:#667eea; }

/* 선택지 */
.choice-row {
  display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap;
}
.choice-row input { margin-bottom:0; }
.choice-label-input { width:50px; text-align:center; flex-shrink:0; }
.choice-text-input { flex:1; min-width:120px; }
.choice-media-input { flex:1; min-width:120px; }
.choice-type-select { width:80px; flex-shrink:0; }
.choice-correct {
  width:20px; height:20px; accent-color:#667eea; cursor:pointer; flex-shrink:0;
}

/* 미리보기 링크 */
.preview-link { color:#667eea; font-size:0.85rem; text-decoration:none; margin-left:10px; }
.preview-link:hover { text-decoration:underline; }

/* 빈 상태 */
.empty-state { text-align:center; padding:40px; color:#555; }

/* 새 퀴즈 폼 */
.new-quiz-form { display:flex; gap:8px; margin-bottom:20px; }
.new-quiz-form input { margin-bottom:0; }
</style>
</head>
<body>
<div class="container">
  <h1>퀴즈 관리</h1>

  <!-- 새 퀴즈 만들기 -->
  <div class="new-quiz-form">
    <input id="new-quiz-title" placeholder="새 퀴즈 제목" style="flex:1">
    <button class="btn btn-primary" onclick="createQuiz()">+ 퀴즈 만들기</button>
  </div>

  <!-- 퀴즈 목록 -->
  <div class="quiz-list" id="quiz-list"></div>

  <!-- 선택된 퀴즈 편집 -->
  <div id="quiz-editor" style="display:none">
    <hr style="border-color:rgba(255,255,255,0.1); margin:20px 0">
    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
      <h2 id="editor-title" style="margin:0"></h2>
      <div>
        <a id="preview-link" class="preview-link" target="_blank">미리보기</a>
        <button class="btn btn-danger btn-sm" onclick="deleteQuiz()">퀴즈 삭제</button>
      </div>
    </div>

    <!-- 퀴즈 정보 수정 -->
    <div style="margin:14px 0">
      <input id="edit-title" placeholder="퀴즈 제목" onchange="updateQuiz()">
      <textarea id="edit-desc" placeholder="설명 (선택)" onchange="updateQuiz()"></textarea>
    </div>

    <!-- 문제 목록 -->
    <div id="questions-area"></div>

    <div class="btn-group">
      <button class="btn btn-primary" onclick="addQuestion('choice')">+ 객관식 문제</button>
      <button class="btn btn-primary" onclick="addQuestion('ox')">+ OX 문제</button>
    </div>
  </div>
</div>

<script>
const API = window.location.origin;
let quizzes = [];
let selectedQuizId = null;
let quizData = null;

// ============ 퀴즈 목록 ============

async function loadQuizzes() {
  const res = await fetch(`${API}/api/quizzes`);
  quizzes = await res.json();
  renderQuizList();
}

function renderQuizList() {
  const el = document.getElementById('quiz-list');
  if (quizzes.length === 0) {
    el.innerHTML = '<div class="empty-state">퀴즈가 없습니다. 위에서 만들어보세요.</div>';
    return;
  }
  el.innerHTML = quizzes.map(q => `
    <div class="quiz-card ${q.id === selectedQuizId ? 'active' : ''}" onclick="selectQuiz(${q.id})">
      <div>
        <div class="quiz-card-title">${esc(q.title)}</div>
        <div class="quiz-card-info">${q.description || ''} | ${q.is_active ? '활성' : '비활성'}</div>
      </div>
      <div class="quiz-card-info">#${q.id}</div>
    </div>
  `).join('');
}

async function createQuiz() {
  const title = document.getElementById('new-quiz-title').value.trim();
  if (!title) return alert('제목을 입력하세요');
  await fetch(`${API}/api/quizzes`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ title })
  });
  document.getElementById('new-quiz-title').value = '';
  await loadQuizzes();
}

async function selectQuiz(id) {
  selectedQuizId = id;
  renderQuizList();
  const res = await fetch(`${API}/api/quizzes/${id}`);
  quizData = await res.json();
  renderEditor();
}

async function updateQuiz() {
  if (!selectedQuizId) return;
  await fetch(`${API}/api/quizzes/${selectedQuizId}`, {
    method:'PUT', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      title: document.getElementById('edit-title').value,
      description: document.getElementById('edit-desc').value
    })
  });
  loadQuizzes();
}

async function deleteQuiz() {
  if (!confirm('정말 삭제?')) return;
  await fetch(`${API}/api/quizzes/${selectedQuizId}`, { method:'DELETE' });
  selectedQuizId = null;
  document.getElementById('quiz-editor').style.display = 'none';
  await loadQuizzes();
}

// ============ 편집기 ============

function renderEditor() {
  document.getElementById('quiz-editor').style.display = 'block';
  document.getElementById('editor-title').textContent = quizData.title;
  document.getElementById('edit-title').value = quizData.title;
  document.getElementById('edit-desc').value = quizData.description || '';
  document.getElementById('preview-link').href = `/?id=${quizData.id}`;

  const area = document.getElementById('questions-area');
  if (!quizData.questions || quizData.questions.length === 0) {
    area.innerHTML = '<div class="empty-state">문제가 없습니다. 아래에서 추가하세요.</div>';
    return;
  }

  area.innerHTML = quizData.questions.map((q, qi) => `
    <div class="question-card" data-qid="${q.id}">
      <div class="question-header">
        <span class="question-num">Q${qi+1} (${q.type === 'ox' ? 'OX' : '객관식'})</span>
        <div>
          <button class="btn btn-sm btn-primary" onclick="addChoice(${q.id}, '${q.type}')">+ 선택지</button>
          <button class="btn btn-sm btn-danger" onclick="deleteQuestion(${q.id})">삭제</button>
        </div>
      </div>
      <input value="${esc(q.text)}" placeholder="문제 내용"
        onchange="updateQuestion(${q.id}, this.value)">
      <div style="margin-top:8px">
        ${(q.choices || []).map(c => `
          <div class="choice-row">
            <input class="choice-label-input" value="${esc(c.label)}" placeholder="A"
              onchange="updateChoice(${c.id}, 'label', this.value)">
            <input class="choice-text-input" value="${esc(c.text)}" placeholder="선택지 내용"
              onchange="updateChoice(${c.id}, 'text', this.value)">
            <input class="choice-media-input" value="${esc(c.media_url || '')}" placeholder="미디어 URL (유튜브/mp4/이미지)"
              onchange="updateChoice(${c.id}, 'media_url', this.value)">
            <select class="choice-type-select" onchange="updateChoice(${c.id}, 'media_type', this.value)">
              <option value="video" ${c.media_type==='video'?'selected':''}>영상</option>
              <option value="image" ${c.media_type==='image'?'selected':''}>이미지</option>
            </select>
            <input type="checkbox" class="choice-correct" title="정답" ${c.is_correct?'checked':''}
              onchange="updateChoice(${c.id}, 'is_correct', this.checked)">
            <button class="btn btn-danger btn-sm" onclick="deleteChoice(${c.id})">X</button>
          </div>
        `).join('')}
      </div>
    </div>
  `).join('');
}

// ============ 문제 CRUD ============

async function addQuestion(type) {
  await fetch(`${API}/api/questions`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      quiz_id: selectedQuizId,
      text: type === 'ox' ? 'O 또는 X?' : '문제를 입력하세요',
      type
    })
  });
  await selectQuiz(selectedQuizId);
}

async function updateQuestion(id, text) {
  await fetch(`${API}/api/questions/${id}`, {
    method:'PUT', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ text })
  });
}

async function deleteQuestion(id) {
  if (!confirm('문제 삭제?')) return;
  await fetch(`${API}/api/questions/${id}`, { method:'DELETE' });
  await selectQuiz(selectedQuizId);
}

// ============ 선택지 CRUD ============

async function addChoice(questionId, type) {
  const labels = type === 'ox' ? ['O','X'] : ['A','B','C','D'];
  const existing = quizData.questions.find(q => q.id === questionId);
  const nextLabel = labels[existing?.choices?.length || 0] || String(existing?.choices?.length + 1);
  await fetch(`${API}/api/choices`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      question_id: questionId,
      label: nextLabel,
      text: type === 'ox' ? nextLabel : '선택지',
      order_num: existing?.choices?.length || 0
    })
  });
  await selectQuiz(selectedQuizId);
}

async function updateChoice(id, field, value) {
  await fetch(`${API}/api/choices/${id}`, {
    method:'PUT', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ [field]: value })
  });
}

async function deleteChoice(id) {
  await fetch(`${API}/api/choices/${id}`, { method:'DELETE' });
  await selectQuiz(selectedQuizId);
}

// ============ 유틸 ============

function esc(str) {
  if (!str) return '';
  return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

loadQuizzes();
</script>
</body>
</html>
