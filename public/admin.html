<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>í€´ì¦ˆ ê´€ë¦¬</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Outfit:wght@700;900&display=swap" rel="stylesheet">
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Noto Sans KR',sans-serif; background:#05050a; color:#e0e0e0; min-height:100vh; padding:20px; }

h1 { font-family:'Outfit',sans-serif; font-size:1.8rem; margin-bottom:20px; color:#fff; }
h2 { font-size:1.1rem; margin:16px 0 8px; color:#888; }

.container { max-width:860px; margin:0 auto; }

/* í€´ì¦ˆ ëª©ë¡ */
.quiz-list { display:flex; flex-direction:column; gap:8px; margin-bottom:24px; }
.quiz-card {
  background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.08);
  border-radius:14px; padding:14px 18px; cursor:pointer;
  display:flex; justify-content:space-between; align-items:center; transition:all 0.2s;
}
.quiz-card:hover { background:rgba(108,92,231,0.08); }
.quiz-card.active { border-color:#6c5ce7; background:rgba(108,92,231,0.12); }
.quiz-card-title { font-weight:700; }
.quiz-card-info { font-size:0.8rem; color:#666; }

/* ë²„íŠ¼ */
.btn { border:none; color:#fff; font-size:0.85rem; font-weight:700; padding:9px 18px; border-radius:10px; cursor:pointer; transition:all 0.2s; }
.btn:hover { opacity:0.85; }
.btn-primary { background:linear-gradient(135deg,#6c5ce7,#764ba2); }
.btn-danger { background:#e74c3c; }
.btn-outline { background:transparent; border:1px solid rgba(255,255,255,0.15); }
.btn-sm { padding:5px 12px; font-size:0.78rem; }
.btn-group { display:flex; gap:6px; flex-wrap:wrap; margin:8px 0; }

/* ì…ë ¥ */
input,textarea,select {
  background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1);
  color:#fff; padding:9px 12px; border-radius:10px; font-size:0.9rem;
  width:100%; margin-bottom:8px; font-family:inherit;
}
input:focus,textarea:focus,select:focus { outline:none; border-color:#6c5ce7; }
textarea { resize:vertical; min-height:50px; }
label { font-size:0.8rem; color:#888; margin-bottom:3px; display:block; }

/* ì²´í¬ë°•ìŠ¤ */
.toggle-row { display:flex; align-items:center; gap:10px; margin:8px 0; }
.toggle-row input[type=checkbox] { width:18px; height:18px; accent-color:#6c5ce7; }
.toggle-row label { margin:0; font-size:0.9rem; color:#ccc; }

/* ë¬¸ì œ ì¹´ë“œ */
.question-card {
  background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.06);
  border-radius:14px; padding:14px; margin-bottom:10px;
}
.question-card.twist { border-color:rgba(255,0,0,0.3); background:rgba(255,0,0,0.03); }
.question-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; }
.question-num { font-weight:700; color:#6c5ce7; font-size:0.9rem; }
.question-num.twist { color:#ff0000; }

/* ì„ íƒì§€ */
.choice-row { display:flex; gap:6px; align-items:center; margin-bottom:6px; flex-wrap:wrap; }
.choice-row input { margin-bottom:0; }
.choice-label-input { width:45px; text-align:center; flex-shrink:0; }
.choice-text-input { flex:1; min-width:100px; }
.choice-media-input { flex:1; min-width:100px; }
.choice-type-select { width:70px; flex-shrink:0; }
.choice-correct { width:18px; height:18px; accent-color:#6c5ce7; cursor:pointer; flex-shrink:0; }
.choice-icon-input { width:40px; text-align:center; flex-shrink:0; font-size:1.1rem; }

/* ìˆœì„œë³€ê²½ ë²„íŠ¼ */
.move-btn {
  background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1);
  color:#aaa; font-size:0.75rem; padding:3px 8px; border-radius:6px; cursor:pointer;
  transition:all 0.15s;
}
.move-btn:hover { background:rgba(108,92,231,0.2); color:#fff; border-color:#6c5ce7; }

/* ì„¤ì • ë°•ìŠ¤ */
.settings-box {
  background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.06);
  border-radius:14px; padding:14px; margin:12px 0;
}
.settings-box h3 { font-size:0.95rem; color:#6c5ce7; margin-bottom:10px; }

/* ë¯¸ë¦¬ë³´ê¸° */
.preview-link { color:#6c5ce7; font-size:0.8rem; text-decoration:none; }
.preview-link:hover { text-decoration:underline; }

.empty-state { text-align:center; padding:30px; color:#444; }
.new-quiz-form { display:flex; gap:6px; margin-bottom:16px; }
.new-quiz-form input { margin-bottom:0; }

.divider { border:none; border-top:1px solid rgba(255,255,255,0.06); margin:16px 0; }

/* CSV */
.csv-area { margin:10px 0; }
.csv-area textarea { min-height:80px; font-size:0.8rem; font-family:monospace; }
</style>
</head>
<body>
<div class="container">
  <h1>QUIZ ADMIN</h1>

  <div class="new-quiz-form">
    <input id="new-quiz-title" placeholder="ìƒˆ í€´ì¦ˆ ì œëª©">
    <button class="btn btn-primary" onclick="createQuiz()">+ ë§Œë“¤ê¸°</button>
  </div>

  <div class="quiz-list" id="quiz-list"></div>

  <div id="quiz-editor" style="display:none">
    <hr class="divider">
    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
      <h2 id="editor-title" style="margin:0"></h2>
      <div style="display:flex;gap:8px;align-items:center">
        <a id="preview-link" class="preview-link" target="_blank">ë¯¸ë¦¬ë³´ê¸°</a>
        <button class="btn btn-danger btn-sm" onclick="deleteQuiz()">ì‚­ì œ</button>
      </div>
    </div>

    <div style="margin:10px 0">
      <input id="edit-title" placeholder="í€´ì¦ˆ ì œëª©" onchange="updateQuiz()">
      <textarea id="edit-desc" placeholder="ì„¤ëª…" onchange="updateQuiz()"></textarea>
    </div>

    <!-- ì„¤ì • -->
    <div class="settings-box">
      <h3>ì„¤ì •</h3>
      <label>ì œí•œì‹œê°„ (ì´ˆ)</label>
      <input id="edit-time-limit" type="number" placeholder="300" onchange="updateQuiz()">

      <div class="toggle-row">
        <input type="checkbox" id="edit-twist" onchange="updateQuiz()">
        <label for="edit-twist">ë°˜ì „ ë¬¸ì œ ì‚¬ìš©</label>
      </div>

      <div id="twist-settings" style="display:none">
        <label>ë°˜ì „ ì „ ë©”ì‹œì§€ (ì¤„ë°”ê¿ˆ: \n)</label>
        <textarea id="edit-twist-msg" placeholder="ë¬¸ì œë¥¼ ì „ë¶€ ë‹¤ í’€ì—ˆìŠµë‹ˆë‹¤\nìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆ" onchange="updateQuiz()"></textarea>
        <label>íƒ€ì´í•‘ í›„ ëŒ€ê¸°ì‹œê°„ (ms)</label>
        <input id="edit-twist-pause" type="number" placeholder="2000" onchange="updateQuiz()">
      </div>
    </div>

    <!-- CSV ê°€ì ¸ì˜¤ê¸° -->
    <div class="settings-box">
      <h3>CSV ê°€ì ¸ì˜¤ê¸°</h3>
      <p style="font-size:0.8rem;color:#666;margin-bottom:8px">í˜•ì‹: ë¬¸ì œ|íƒ€ì…|ì„ íƒì§€ë¼ë²¨|ì„ íƒì§€í…ìŠ¤íŠ¸|ë¯¸ë””ì–´URL|ë¯¸ë””ì–´íƒ€ì…|ì •ë‹µì—¬ë¶€|ë°˜ì „ì—¬ë¶€</p>
      <div class="csv-area">
        <textarea id="csv-input" placeholder="CSV ë¶™ì—¬ë„£ê¸°"></textarea>
        <button class="btn btn-outline btn-sm" onclick="importCSV()">CSV ê°€ì ¸ì˜¤ê¸°</button>
        <button class="btn btn-outline btn-sm" onclick="exportCSV()">CSV ë‚´ë³´ë‚´ê¸°</button>
      </div>
    </div>

    <!-- ë¬¸ì œ ëª©ë¡ -->
    <div id="questions-area"></div>

    <div class="btn-group">
      <button class="btn btn-primary" onclick="addQuestion('choice')">+ ê°ê´€ì‹</button>
      <button class="btn btn-primary" onclick="addQuestion('ox')">+ OX</button>
      <button class="btn btn-primary" style="background:linear-gradient(135deg,#00cec9,#0984e3)" onclick="addQuestion('input')">+ ì…ë ¥í˜•</button>
      <button class="btn btn-primary" style="background:linear-gradient(135deg,#e74c3c,#c0392b)" onclick="addQuestion('choice', true)">+ ë°˜ì „ ë¬¸ì œ</button>
    </div>
  </div>
</div>

<script>
const API = window.location.origin;
let quizzes = [], selectedQuizId = null, quizData = null;

async function loadQuizzes() {
  quizzes = await (await fetch(`${API}/api/quizzes`)).json();
  renderQuizList();
}

function renderQuizList() {
  const el = document.getElementById('quiz-list');
  if (!quizzes.length) { el.innerHTML = '<div class="empty-state">í€´ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤</div>'; return; }
  el.innerHTML = quizzes.map(q => `
    <div class="quiz-card ${q.id===selectedQuizId?'active':''}" onclick="selectQuiz(${q.id})">
      <div><div class="quiz-card-title">${esc(q.title)}</div><div class="quiz-card-info">${q.description||''}</div></div>
      <div class="quiz-card-info">#${q.id}</div>
    </div>`).join('');
}

async function createQuiz() {
  const t = document.getElementById('new-quiz-title').value.trim();
  if (!t) return;
  await fetch(`${API}/api/quizzes`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({title:t}) });
  document.getElementById('new-quiz-title').value = '';
  await loadQuizzes();
}

async function selectQuiz(id) {
  selectedQuizId = id;
  renderQuizList();
  quizData = await (await fetch(`${API}/api/quizzes/${id}`)).json();
  renderEditor();
}

async function updateQuiz() {
  if (!selectedQuizId) return;
  const twistEnabled = document.getElementById('edit-twist').checked;
  document.getElementById('twist-settings').style.display = twistEnabled ? 'block' : 'none';
  await fetch(`${API}/api/quizzes/${selectedQuizId}`, {
    method:'PUT', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      title: document.getElementById('edit-title').value,
      description: document.getElementById('edit-desc').value,
      time_limit: parseInt(document.getElementById('edit-time-limit').value) || 300,
      twist_enabled: twistEnabled,
      twist_message: document.getElementById('edit-twist-msg').value,
      twist_pause_ms: parseInt(document.getElementById('edit-twist-pause').value) || 2000
    })
  });
  loadQuizzes();
}

async function deleteQuiz() {
  if (!confirm('ì‚­ì œ?')) return;
  await fetch(`${API}/api/quizzes/${selectedQuizId}`, {method:'DELETE'});
  selectedQuizId = null;
  document.getElementById('quiz-editor').style.display = 'none';
  await loadQuizzes();
}

function renderEditor() {
  const ed = document.getElementById('quiz-editor');
  ed.style.display = 'block';
  document.getElementById('editor-title').textContent = quizData.title;
  document.getElementById('edit-title').value = quizData.title;
  document.getElementById('edit-desc').value = quizData.description || '';
  document.getElementById('edit-time-limit').value = quizData.time_limit || 300;
  document.getElementById('edit-twist').checked = quizData.twist_enabled || false;
  document.getElementById('edit-twist-msg').value = quizData.twist_message || '';
  document.getElementById('edit-twist-pause').value = quizData.twist_pause_ms || 2000;
  document.getElementById('twist-settings').style.display = quizData.twist_enabled ? 'block' : 'none';
  document.getElementById('preview-link').href = `/?id=${quizData.id}`;

  const area = document.getElementById('questions-area');
  if (!quizData.questions || !quizData.questions.length) {
    area.innerHTML = '<div class="empty-state">ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤</div>';
    return;
  }

  let normalIdx = 0;
  const qs = quizData.questions;
  area.innerHTML = qs.map((q, qi) => {
    const isTwist = q.is_twist;
    if (!isTwist) normalIdx++;
    const prevId = qi > 0 ? qs[qi-1].id : null;
    const nextId = qi < qs.length-1 ? qs[qi+1].id : null;
    return `
    <div class="question-card ${isTwist?'twist':''}" data-qid="${q.id}">
      <div class="question-header">
        <span class="question-num ${isTwist?'twist':''}">${isTwist ? 'TWIST (ë°˜ì „)' : `Q${normalIdx} (${q.type==='ox'?'OX':q.type==='input'?'ì…ë ¥í˜•':'ê°ê´€ì‹'})`}</span>
        <div style="display:flex;gap:4px;align-items:center">
          ${prevId ? `<button class="move-btn" onclick="swapQuestion(${q.id},${prevId})" title="ìœ„ë¡œ">â–²</button>` : ''}
          ${nextId ? `<button class="move-btn" onclick="swapQuestion(${q.id},${nextId})" title="ì•„ë˜ë¡œ">â–¼</button>` : ''}
          ${q.type!=='input'?`<button class="btn btn-sm btn-primary" onclick="addChoice(${q.id},'${q.type}')">+ ì„ íƒì§€</button>`:''}
          <button class="btn btn-sm btn-danger" onclick="deleteQuestion(${q.id})">ì‚­ì œ</button>
        </div>
      </div>
      <input value="${esc(q.text)}" placeholder="ë¬¸ì œ ë‚´ìš©" onchange="updateQuestion(${q.id},this.value)">
      <div style="margin-top:6px">
        ${q.type==='input' ? '<div style="color:#666;font-size:0.8rem;padding:8px;border:1px dashed rgba(255,255,255,0.08);border-radius:8px">ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•˜ëŠ” ë¬¸ì œì…ë‹ˆë‹¤ (ì„ íƒì§€ ì—†ìŒ)</div>' : (q.choices||[]).map(c => `
          <div class="choice-row">
            <input class="choice-icon-input" value="${esc(c.icon||'')}" placeholder="ğŸ¯" title="ì•„ì´ì½˜" onchange="updateChoice(${c.id},'icon',this.value)">
            <input class="choice-label-input" value="${esc(c.label)}" placeholder="A" onchange="updateChoice(${c.id},'label',this.value)">
            <input class="choice-text-input" value="${esc(c.text)}" placeholder="ì„ íƒì§€" onchange="updateChoice(${c.id},'text',this.value)">
            <input class="choice-media-input" value="${esc(c.media_url||'')}" placeholder="ë¯¸ë””ì–´ URL" onchange="updateChoice(${c.id},'media_url',this.value)">
            <select class="choice-type-select" onchange="updateChoice(${c.id},'media_type',this.value)">
              <option value="video" ${c.media_type==='video'?'selected':''}>ì˜ìƒ</option>
              <option value="image" ${c.media_type==='image'?'selected':''}>ì´ë¯¸ì§€</option>
            </select>
            <input type="checkbox" class="choice-correct" title="ì •ë‹µ" ${c.is_correct?'checked':''} onchange="updateChoice(${c.id},'is_correct',this.checked)">
            <button class="btn btn-danger btn-sm" onclick="deleteChoice(${c.id})">X</button>
          </div>`).join(''))}
      </div>
    </div>`;
  }).join('');
}

// ë¬¸ì œ CRUD
async function addQuestion(type, isTwist) {
  await fetch(`${API}/api/questions`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ quiz_id:selectedQuizId, text:isTwist?'ë°˜ì „ ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”':type==='input'?'ë‹µì„ ì…ë ¥í•´ì£¼ì„¸ìš”':type==='ox'?'O ë˜ëŠ” X?':'ë¬¸ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”', type, is_twist:!!isTwist })
  });
  await selectQuiz(selectedQuizId);
}
async function updateQuestion(id, text) {
  await fetch(`${API}/api/questions/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({text}) });
}
async function deleteQuestion(id) {
  if (!confirm('ì‚­ì œ?')) return;
  await fetch(`${API}/api/questions/${id}`, {method:'DELETE'});
  await selectQuiz(selectedQuizId);
}
async function swapQuestion(id1, id2) {
  await fetch(`${API}/api/questions/swap`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({id1, id2})
  });
  await selectQuiz(selectedQuizId);
}

// ì„ íƒì§€ CRUD
async function addChoice(qid, type) {
  const labels = type==='ox'?['O','X']:['A','B','C','D'];
  const q = quizData.questions.find(x=>x.id===qid);
  const nl = labels[q?.choices?.length||0] || String((q?.choices?.length||0)+1);
  await fetch(`${API}/api/choices`, {
    method:'POST', headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ question_id:qid, label:nl, text:type==='ox'?nl:'ì„ íƒì§€', order_num:q?.choices?.length||0 })
  });
  await selectQuiz(selectedQuizId);
}
async function updateChoice(id, field, value) {
  await fetch(`${API}/api/choices/${id}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({[field]:value}) });
}
async function deleteChoice(id) {
  await fetch(`${API}/api/choices/${id}`, {method:'DELETE'});
  await selectQuiz(selectedQuizId);
}

// CSV
async function importCSV() {
  const text = document.getElementById('csv-input').value.trim();
  if (!text) return;
  const lines = text.split('\n').filter(l=>l.trim());
  let currentQid = null;
  for (const line of lines) {
    const cols = line.split('|').map(c=>c.trim());
    if (cols.length < 4) continue;
    const [question, type, label, choiceText, mediaUrl, mediaType, isCorrect, isTwist] = cols;
    if (question) {
      const res = await fetch(`${API}/api/questions`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ quiz_id:selectedQuizId, text:question, type:type||'choice', is_twist:isTwist==='true'||isTwist==='1' })
      });
      const q = await res.json();
      currentQid = q.id;
    }
    if (currentQid && label) {
      await fetch(`${API}/api/choices`, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ question_id:currentQid, label, text:choiceText||label, media_url:mediaUrl||null, media_type:mediaType||'video', is_correct:isCorrect==='true'||isCorrect==='1' })
      });
    }
  }
  document.getElementById('csv-input').value = '';
  await selectQuiz(selectedQuizId);
}

function exportCSV() {
  if (!quizData || !quizData.questions) return;
  let csv = 'ë¬¸ì œ|íƒ€ì…|ë¼ë²¨|ì„ íƒì§€|ë¯¸ë””ì–´URL|ë¯¸ë””ì–´íƒ€ì…|ì •ë‹µ|ë°˜ì „\n';
  quizData.questions.forEach(q => {
    (q.choices||[]).forEach((c,i) => {
      csv += `${i===0?q.text:''}|${i===0?q.type:''}|${c.label}|${c.text}|${c.media_url||''}|${c.media_type}|${c.is_correct}|${q.is_twist}\n`;
    });
  });
  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `quiz_${selectedQuizId}.csv`;
  a.click();
}

function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

loadQuizzes();
</script>
</body>
</html>
